<?xml version="1.0" encoding="iso-8859-1"?>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Creating a Simple DSL in Perl</title>
		<meta charset="utf-8"/>
		<style>
		.xml_tag_start { font-weight: bold }
		.xml_tagname { color: #009 }
		.xml_data { color: #444 }
		</style>
	</head>
	<body class="pod">
		<span id="___top"/>
		<h1><span id="Creating_a_Simple_DSL_in_Perl">Creating a Simple DSL in Perl</span></h1>
		<p>Let's look at the XSPF playlist format. It's a pretty simple XML-based file format.</p>
		<!-- for highlighter language=XML -->
		<pre class="highlighting-xml">  <span class="xml_tag_start xml_tag_is_pi xml_tag_is_opening" data-xml-name="xml"><span class="xml_pointy">&lt;?</span><span class="xml_tagname">xml</span> <span class="xml_attributename" style="color:#009999">version</span><span class="xml_equals">=</span><span class="xml_attributevalue" style="color:#990099">"1.0"</span> <span class="xml_attributename" style="color:#009999">encoding</span><span class="xml_equals">=</span><span class="xml_attributevalue" style="color:#990099">"UTF-8"</span><span class="xml_pointy">?&gt;</span></span>
  <span class="xml_tag_start xml_tag_is_opening" data-xml-name="playlist"><span class="xml_pointy">&lt;</span><span class="xml_tagname">playlist</span> <span class="xml_attribute_start" data-xml-name="version"><span class="xml_attributename" style="color:#009999">version</span><span class="xml_equals">=</span><span class="xml_attributevalue" style="color:#990099">"1"</span></span> <span class="xml_attribute_start xml_attribute_is_xmlns" data-xml-name="xmlns"><span class="xml_attributename" style="color:#009999">xmlns</span><span class="xml_equals">=</span><span class="xml_attributevalue" style="color:#990099">"http://xspf.org/ns/0/"</span></span><span class="xml_pointy">&gt;</span></span>
    <span class="xml_tag_start xml_tag_is_opening" data-xml-name="title"><span class="xml_pointy">&lt;</span><span class="xml_tagname">title</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">80's Music</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="title"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">title</span><span class="xml_pointy">&gt;</span></span>
    <span class="xml_tag_start xml_tag_is_opening" data-xml-name="trackList"><span class="xml_pointy">&lt;</span><span class="xml_tagname">trackList</span><span class="xml_pointy">&gt;</span></span>
      <span class="xml_tag_start xml_tag_is_opening" data-xml-name="track"><span class="xml_pointy">&lt;</span><span class="xml_tagname">track</span><span class="xml_pointy">&gt;</span></span>
        <span class="xml_tag_start xml_tag_is_opening" data-xml-name="title"><span class="xml_pointy">&lt;</span><span class="xml_tagname">title</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">Take On Me</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="title"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">title</span><span class="xml_pointy">&gt;</span></span>
        <span class="xml_tag_start xml_tag_is_opening" data-xml-name="creator"><span class="xml_pointy">&lt;</span><span class="xml_tagname">creator</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">A-ha</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="creator"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">creator</span><span class="xml_pointy">&gt;</span></span>
        <span class="xml_tag_start xml_tag_is_opening" data-xml-name="location"><span class="xml_pointy">&lt;</span><span class="xml_tagname">location</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">https://example.com/music/01.mp3</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="location"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">location</span><span class="xml_pointy">&gt;</span></span>
      <span class="xml_tag_start xml_tag_is_closing" data-xml-name="track"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">track</span><span class="xml_pointy">&gt;</span></span>
      <span class="xml_tag_start xml_tag_is_opening" data-xml-name="track"><span class="xml_pointy">&lt;</span><span class="xml_tagname">track</span><span class="xml_pointy">&gt;</span></span>
        <span class="xml_tag_start xml_tag_is_opening" data-xml-name="title"><span class="xml_pointy">&lt;</span><span class="xml_tagname">title</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">Tainted Love</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="title"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">title</span><span class="xml_pointy">&gt;</span></span>
        <span class="xml_tag_start xml_tag_is_opening" data-xml-name="creator"><span class="xml_pointy">&lt;</span><span class="xml_tagname">creator</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">Soft Cell</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="creator"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">creator</span><span class="xml_pointy">&gt;</span></span>
        <span class="xml_tag_start xml_tag_is_opening" data-xml-name="location"><span class="xml_pointy">&lt;</span><span class="xml_tagname">location</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">https://example.com/music/02.mp3</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="location"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">location</span><span class="xml_pointy">&gt;</span></span>
      <span class="xml_tag_start xml_tag_is_closing" data-xml-name="track"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">track</span><span class="xml_pointy">&gt;</span></span>
      <span class="xml_tag_start xml_tag_is_opening" data-xml-name="track"><span class="xml_pointy">&lt;</span><span class="xml_tagname">track</span><span class="xml_pointy">&gt;</span></span>
        <span class="xml_tag_start xml_tag_is_opening" data-xml-name="title"><span class="xml_pointy">&lt;</span><span class="xml_tagname">title</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">Livin' on a Prayer</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="title"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">title</span><span class="xml_pointy">&gt;</span></span>
        <span class="xml_tag_start xml_tag_is_opening" data-xml-name="creator"><span class="xml_pointy">&lt;</span><span class="xml_tagname">creator</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">Bon Jovi</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="creator"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">creator</span><span class="xml_pointy">&gt;</span></span>
        <span class="xml_tag_start xml_tag_is_opening" data-xml-name="location"><span class="xml_pointy">&lt;</span><span class="xml_tagname">location</span><span class="xml_pointy">&gt;</span></span><span class="xml_data">https://example.com/music/03.mp3</span><span class="xml_tag_start xml_tag_is_closing" data-xml-name="location"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">location</span><span class="xml_pointy">&gt;</span></span>
      <span class="xml_tag_start xml_tag_is_closing" data-xml-name="track"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">track</span><span class="xml_pointy">&gt;</span></span>
      <span class="xml_tag_start xml_tag_is_closing" data-xml-name="track"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">track</span><span class="xml_pointy">&gt;</span></span>
    <span class="xml_tag_start xml_tag_is_closing" data-xml-name="trackList"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">trackList</span><span class="xml_pointy">&gt;</span></span>
  <span class="xml_tag_start xml_tag_is_closing" data-xml-name="playlist"><span class="xml_pointy">&lt;</span><span class="xml_slash">/</span><span class="xml_tagname">playlist</span><span class="xml_pointy">&gt;</span></span></pre>
		<p>The <a class="podlinkurl" href="https://xspf.org/spec">full specification</a> has a lot more details, but for now, we'll just use those elements.</p>
		<p>If we are building a Perl application that needs to allow less experienced users to write playlists in Perl, it might be useful to define a domain-specific dialect of Perl for writing playlists.</p>
		<p>Something like this:</p>
		<!-- for highlighter language=Perl -->
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$pl</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">playlist</span> <span class="structure">{</span>
    <span class="word">title</span> <span class="double" style="color:#909">"80's Music"</span><span class="structure">;</span>
    <span class="word">track</span> <span class="structure">{</span>
      <span class="word">location</span> <span class="double" style="color:#909">"https://example.com/music/01.mp3"</span><span class="structure">;</span>
      <span class="word">title</span> <span class="double" style="color:#909">"Take On Me"</span><span class="structure">;</span>
      <span class="word">creator</span> <span class="double" style="color:#909">"A-ha"</span><span class="structure">;</span>
    <span class="structure">};</span>
    <span class="word">track</span> <span class="structure">{</span>
      <span class="word">location</span> <span class="double" style="color:#909">"https://example.com/music/02.mp3"</span><span class="structure">;</span>
      <span class="word">title</span> <span class="double" style="color:#909">"Tainted Love"</span><span class="structure">;</span>
      <span class="word">creator</span> <span class="double" style="color:#909">"Soft Cell"</span><span class="structure">;</span>
    <span class="structure">};</span>
    <span class="word">track</span> <span class="structure">{</span>
      <span class="word">location</span> <span class="double" style="color:#909">"https://example.com/music/03.mp3"</span><span class="structure">;</span>
      <span class="word">title</span> <span class="double" style="color:#909">"Livin' on a Prayer"</span><span class="structure">;</span>
      <span class="word">creator</span> <span class="double" style="color:#909">"Bon Jovi"</span><span class="structure">;</span>
    <span class="structure">};</span>
  <span class="structure">};</span></pre>
		<p>It is actually pretty simple to do this!</p>
		<h2><span id="The_playlist_function">The <code>playlist</code> function</span></h2>
		<p>A simple implementation of the <code>playlist</code> function is this:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="structure">;</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">playlist</span> <span class="prototype">(&amp;)</span> <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$block</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="structure">;</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="structure">{};</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$block</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">();</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="structure">;</span>
  <span class="structure">}</span></pre>
		<p>The prototype of <code>(&amp;)</code> allows a function to accept a block of code. Our <code>playlist</code> function wants to create a blank playlist (which we'll implement as an empty hashref), run the block (which will define the tracks), and then return the playlist.</p>
		<p>The reason that the <code>$current_playlist</code> variable is declared <i>outside</i> the function is so that other functions (such as <code>title</code>) can access it.</p>
		<p>Here's an implementation for <code>title</code>:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">title</span> <span class="prototype">($)</span> <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="structure">;</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span><span class="word">title</span><span class="structure">}</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span><span class="structure">;</span>
  <span class="structure">}</span></pre>
		<p>And we'll use <a class="podlinkpod" href="https://metacpan.org/pod/Exporter%3A%3AShiny">Exporter::Shiny</a> to export our functions. Other exporters also exist.</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Exporter::Shiny</span> <span class="words" style="color:#333;background-color:#ffc">qw( playlist title )</span><span class="structure">;</span></pre>
		<p>Let's test it:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">XML::XSPF</span> <span class="word">-all</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Test2::V0</span><span class="structure">;</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$pl</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">playlist</span> <span class="structure">{</span>
    <span class="word">title</span> <span class="double" style="color:#909">"Test 123"</span><span class="structure">;</span>
  <span class="structure">};</span>
  
  <span class="word">is</span><span class="structure">(</span> <span class="symbol" style="color:#333;background-color:#fcc">$pl</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="structure">{</span> <span class="word">title</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"Test 123"</span> <span class="structure">}</span> <span class="structure">);</span>
  
  <span class="word">done_testing</span><span class="structure">;</span></pre>
		<p>Yay! It works!</p>
		<h2><span id="Some_sanity_checks">Some sanity checks</span></h2>
		<p>We should add some checks to make sure <code>title</code> is only ever used inside a playlist, and also ensure that playlists are not nested.</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Carp</span> <span class="words" style="color:#333;background-color:#ffc">qw( croak )</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Scope::Guard</span> <span class="words" style="color:#333;background-color:#ffc">qw( guard )</span><span class="structure">;</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="structure">;</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">playlist</span> <span class="prototype">(&amp;)</span> <span class="structure">{</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$block</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="structure">;</span>
    
    <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span> <span class="operator" style="color:#000;font-weight:bold">and</span> <span class="word">croak</span><span class="structure">(</span> <span class="double" style="color:#909">"Nested playlist"</span> <span class="structure">)</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="structure">{};</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$guard</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">guard</span> <span class="structure">{</span> <span class="core" style="color:#009;font-weight:bold">undef</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span> <span class="structure">};</span>
    
    <span class="symbol" style="color:#333;background-color:#fcc">$block</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">();</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="structure">;</span>
  <span class="structure">}</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">title</span> <span class="prototype">($)</span> <span class="structure">{</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="structure">;</span>
    
    <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span> <span class="operator" style="color:#000;font-weight:bold">or</span> <span class="word">croak</span><span class="structure">(</span> <span class="double" style="color:#909">"Title outside playlist"</span> <span class="structure">);</span>
    
    <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span><span class="word">title</span><span class="structure">}</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span><span class="structure">;</span>
  <span class="structure">}</span></pre>
		<p>Using a <code>guard</code> to undef <code>$current_playlist</code> at the end of building a playlist ensures it will always happen, even if the block throws an exception, so we never end up with <code>$current_playlist</code> remaining dirty at the end of a <code>playlist</code> block.</p>
		<h2><span id="Expanding_on_all_that">Expanding on all that</span></h2>
		<p>Expanding upon these ideas to also provide <code>track</code>, <code>creator</code>, and <code>location</code> functions, we get:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="float">5.010001</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="pragma" style="color:#009">strict</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="pragma" style="color:#009">warnings</span><span class="structure">;</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">package</span> <span class="word">XML::XSPF</span><span class="structure">;</span>
  
<span class="comment" style="color:#060;font-style:italic">  # Utility functions we need.
</span>  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Carp</span> <span class="words" style="color:#333;background-color:#ffc">qw( croak )</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Scope::Guard</span> <span class="words" style="color:#333;background-color:#ffc">qw( guard )</span><span class="structure">;</span>
  
<span class="comment" style="color:#060;font-style:italic">  # Functions we will export.
</span>  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Exporter::Shiny</span> <span class="words" style="color:#333;background-color:#ffc">qw(
    playlist
    track
    title
    creator
    location
  )</span><span class="structure">;</span>
  
<span class="comment" style="color:#060;font-style:italic">  # Scratchpad for storing playlists and tracks while they are
  # being built.
</span>  <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span><span class="structure">;</span>
  
<span class="comment" style="color:#060;font-style:italic">  # Function called to define a new playlist.
</span>  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">playlist</span> <span class="prototype">(&amp;)</span> <span class="structure">{</span>
    
<span class="comment" style="color:#060;font-style:italic">    # It accepts a block of Perl code (which will define tracks, etc).
</span>    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$block</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="structure">;</span>
    
<span class="comment" style="color:#060;font-style:italic">    # Ensure that there isn't already a half-built playlist, and then
    # start building one. The guard ensures that the playlist will be
    # cleaned up at the end of this function, even if an exception gets
    # thrown later.
</span>    <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span> <span class="operator" style="color:#000;font-weight:bold">and</span> <span class="word">croak</span><span class="structure">(</span> <span class="double" style="color:#909">"Nested playlist"</span> <span class="structure">);</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="structure">{};</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$guard</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">guard</span> <span class="structure">{</span> <span class="core" style="color:#009;font-weight:bold">undef</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span> <span class="structure">};</span>
    
<span class="comment" style="color:#060;font-style:italic">    # Run the block we were given.
</span>    <span class="symbol" style="color:#333;background-color:#fcc">$block</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">();</span>
    
<span class="comment" style="color:#060;font-style:italic">    # Return the complete playlist.
</span>    <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="structure">;</span>
  <span class="structure">}</span>
  
<span class="comment" style="color:#060;font-style:italic">  # Function called to define a new track.
</span>  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">track</span> <span class="prototype">(&amp;)</span> <span class="structure">{</span>
    
<span class="comment" style="color:#060;font-style:italic">    # It accepts a block of Perl code (which will add track details).
</span>    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$block</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="structure">;</span>
    
<span class="comment" style="color:#060;font-style:italic">    # Ensure that there isn't already a half-built track, and we haven't
    # been called outside a playlist, and then start building a track.
    # The guard ensures that the track will be cleaned up at the end of
    # this function, even if an exception gets thrown later.
</span>    <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span> <span class="operator" style="color:#000;font-weight:bold">and</span> <span class="word">croak</span><span class="structure">(</span> <span class="double" style="color:#909">"Nested track"</span> <span class="structure">);</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span> <span class="operator" style="color:#000;font-weight:bold">or</span> <span class="word">croak</span><span class="structure">(</span> <span class="double" style="color:#909">"Track outside playlist"</span> <span class="structure">);</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="structure">{};</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$guard</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">guard</span> <span class="structure">{</span> <span class="core" style="color:#009;font-weight:bold">undef</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span> <span class="structure">};</span>
    
<span class="comment" style="color:#060;font-style:italic">    # Run the block we were given.
</span>    <span class="symbol" style="color:#333;background-color:#fcc">$block</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">();</span>
    
<span class="comment" style="color:#060;font-style:italic">    # Add the built track to the playlist. Return nothing.
</span>    <span class="word">push</span> <span class="cast" style="color:#f00;font-weight:bold">@</span><span class="structure">{</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span><span class="word">trackList</span><span class="structure">}</span> <span class="operator" style="color:#000;font-weight:bold">//=</span> <span class="structure">[]</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span><span class="structure">;</span>
  <span class="structure">}</span>
  
<span class="comment" style="color:#060;font-style:italic">  # Function to set the title for current track or playlist.
</span>  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">title</span> <span class="prototype">($)</span> <span class="structure">{</span>
    
<span class="comment" style="color:#060;font-style:italic">    # It accepts a string.
</span>    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="structure">;</span>
    
<span class="comment" style="color:#060;font-style:italic">    # If there's a track being built, that's the target. Otherwise,
    # the target is the playlist being built. It's an error to call
    # this function if neither is being built.
</span>    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$target</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span> <span class="operator" style="color:#000;font-weight:bold">//</span> <span class="symbol" style="color:#333;background-color:#fcc">$current_playlist</span><span class="structure">;</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$target</span> <span class="operator" style="color:#000;font-weight:bold">//</span> <span class="word">croak</span><span class="structure">(</span> <span class="double" style="color:#909">"Title outside playlist or track"</span> <span class="structure">);</span>
    
<span class="comment" style="color:#060;font-style:italic">    # Set the title. Return nothing.
</span>    <span class="symbol" style="color:#333;background-color:#fcc">$target</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span><span class="word">title</span><span class="structure">}</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span><span class="structure">;</span>
  <span class="structure">}</span>
  
<span class="comment" style="color:#060;font-style:italic">  # Function to set the location for current track.
</span>  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">location</span> <span class="prototype">($)</span> <span class="structure">{</span>
    
<span class="comment" style="color:#060;font-style:italic">    # It accepts a string.
</span>    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="structure">;</span>
    
<span class="comment" style="color:#060;font-style:italic">    # It's an error to call this function if no track is being built.
</span>    <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span> <span class="operator" style="color:#000;font-weight:bold">//</span> <span class="word">croak</span><span class="structure">(</span> <span class="double" style="color:#909">"Location outside track"</span> <span class="structure">);</span>
    
<span class="comment" style="color:#060;font-style:italic">    # Set the location of the current track. Return nothing.
</span>    <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span><span class="word">location</span><span class="structure">}</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span><span class="structure">;</span>
  <span class="structure">}</span>
  
<span class="comment" style="color:#060;font-style:italic">  # Function to set the creator for current track.
</span>  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">creator</span> <span class="prototype">($)</span> <span class="structure">{</span>
    
<span class="comment" style="color:#060;font-style:italic">    # It accepts a string.
</span>    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="structure">;</span>
    
<span class="comment" style="color:#060;font-style:italic">    # It's an error to call this function if no track is being built.
</span>    <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span> <span class="operator" style="color:#000;font-weight:bold">//</span> <span class="word">croak</span><span class="structure">(</span> <span class="double" style="color:#909">"Creator outside track"</span> <span class="structure">);</span>
    
<span class="comment" style="color:#060;font-style:italic">    # Set the creator of the current track. Return nothing.
</span>    <span class="symbol" style="color:#333;background-color:#fcc">$current_track</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span><span class="word">creator</span><span class="structure">}</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="symbol" style="color:#333;background-color:#fcc">$string</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span><span class="structure">;</span>
  <span class="structure">}</span>
  
  <span class="number" style="color:#39C">1</span><span class="structure">;</span></pre>
		<p>And here's a simple test:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Test2::V0</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Data::Dumper</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">XML::XSPF</span> <span class="word">-all</span><span class="structure">;</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$pl</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">playlist</span> <span class="structure">{</span>
    <span class="word">title</span> <span class="double" style="color:#909">"80's Music"</span><span class="structure">;</span>
    <span class="word">track</span> <span class="structure">{</span>
      <span class="word">location</span> <span class="double" style="color:#909">"https://example.com/music/01.mp3"</span><span class="structure">;</span>
      <span class="word">title</span> <span class="double" style="color:#909">"Take On Me"</span><span class="structure">;</span>
      <span class="word">creator</span> <span class="double" style="color:#909">"A-ha"</span><span class="structure">;</span>
    <span class="structure">};</span>
    <span class="word">track</span> <span class="structure">{</span>
      <span class="word">location</span> <span class="double" style="color:#909">"https://example.com/music/02.mp3"</span><span class="structure">;</span>
      <span class="word">title</span> <span class="double" style="color:#909">"Tainted Love"</span><span class="structure">;</span>
      <span class="word">creator</span> <span class="double" style="color:#909">"Soft Cell"</span><span class="structure">;</span>
    <span class="structure">};</span>
    <span class="word">track</span> <span class="structure">{</span>
      <span class="word">location</span> <span class="double" style="color:#909">"https://example.com/music/03.mp3"</span><span class="structure">;</span>
      <span class="word">title</span> <span class="double" style="color:#909">"Livin' on a Prayer"</span><span class="structure">;</span>
      <span class="word">creator</span> <span class="double" style="color:#909">"Bon Jovi"</span><span class="structure">;</span>
    <span class="structure">};</span>
  <span class="structure">};</span>
  
  <span class="word">is</span><span class="structure">(</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$pl</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="structure">{</span>
      <span class="word">title</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"80's Music"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
      <span class="word">trackList</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="structure">[</span>
        <span class="structure">{</span>
          <span class="word">creator</span>  <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"A-ha"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
          <span class="word">location</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"https://example.com/music/01.mp3"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
          <span class="word">title</span>    <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"Take On Me"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
        <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
        <span class="structure">{</span>
          <span class="word">creator</span>  <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"Soft Cell"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
          <span class="word">location</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"https://example.com/music/02.mp3"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
          <span class="word">title</span>    <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"Tainted Love"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
        <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
        <span class="structure">{</span>
          <span class="word">creator</span>  <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"Bon Jovi"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
          <span class="word">location</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"https://example.com/music/03.mp3"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
          <span class="word">title</span>    <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="double" style="color:#909">"Livin' on a Prayer"</span><span class="operator" style="color:#000;font-weight:bold">,</span>
        <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
      <span class="structure">]</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
  <span class="structure">)</span> <span class="operator" style="color:#000;font-weight:bold">or</span> <span class="word">diag</span> <span class="word">Dumper</span><span class="structure">(</span> <span class="symbol" style="color:#333;background-color:#fcc">$pl</span> <span class="structure">);</span>
  
  <span class="word">done_testing</span><span class="structure">;</span></pre>
		<p>If you try it out, it should pass.</p>
		<h2><span id="Next_steps">Next steps</span></h2>
		<p>A good next step might be for <code>playlist</code> to build a blessed <code>XML::XSPF::Playlist</code> object, and <code>track</code> to build blessed <code>XML::XSPF::Track</code> objects. <code>XML::XSPF::Playlist</code> could offer a <code>to_xml</code> method.</p>
		<p>These improvements are left as an exercise to the reader.</p>
	</body>
</html>
